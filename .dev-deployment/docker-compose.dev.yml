# Docker Compose override for local development
# This file mounts local source code for live development with Django runserver
#
# Usage: docker compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  cdcs:
    # Mount local NexusLIMS-CDCS source code
    volumes:
      - ..:/srv/curator:delegated
      - cdcs_media:/srv/curator/media
      - cdcs_socket:/tmp/curator/
      - cdcs_static:/srv/curator/static.prod
      # Override with dev settings
      - ./cdcs/dev_settings.py:/srv/curator/mdcs/dev_settings.py

    environment:
      # Enable Django debug mode
      - DJANGO_DEBUG=True
      # Use development settings
      - DJANGO_SETTINGS_MODULE=${PROJECT_NAME}.dev_settings

    # Override entrypoint and command to use Django runserver for auto-reload
    entrypoint: []
    command:
      - /bin/bash
      - -c
      - |
        set -e
        echo "********* Development Mode - Waiting for Postgres *********"
        until python -c "import socket; socket.create_connection(('nexuslims_dev_cdcs_postgres', 5432), timeout=1)" 2>/dev/null; do
          sleep 1
        done
        echo "********* Running Migrations *********"
        cd /srv/curator
        python manage.py migrate --noinput
        echo "********* Collecting Static Files *********"
        python manage.py collectstatic --noinput
        echo "********* Starting Django Development Server with Auto-Reload *********"
        echo "********* NexusLIMS-CDCS available at https://nexuslims-dev.localhost *********"
        python manage.py runserver 0.0.0.0:8000
