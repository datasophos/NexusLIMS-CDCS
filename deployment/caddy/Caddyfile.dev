{
    # Global options
    admin off

    # Configure PKI to use custom CA for automatic certificate generation
    pki {
        ca local {
            name "NexusLIMS Local CA"
            root {
                format pem_file
                cert /etc/caddy/certs/ca.crt
                key /etc/caddy/certs/ca.key
            }
        }
    }
}

# Main application
https://{$DOMAIN} {
    # Auto-generate short-lived certificates from custom CA
    tls {
        issuer internal {
            ca local
        }
    }

    # Reverse proxy to the NexusLIMS-CDCS application via HTTP
    reverse_proxy cdcs:8000 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
    }

    # Serve static files
    handle_path /static/* {
        root * /srv/nexuslims_static
        file_server
    }

    # Enable file uploads up to 100MB (for NexusLIMS data files)
    request_body {
        max_size 100MB
    }

    # Logging
    log {
        output stdout
        format console
    }
}

# File server
https://{$FILES_DOMAIN} {
    # Auto-generate short-lived certificates from custom CA
    tls {
        issuer internal {
            ca local
        }
    }

    # Logging
    log {
        output stdout
        format console
    }

    route {
        # Redirect paths without trailing slash to include it
        @dataNoSlash path /data
        redir @dataNoSlash /data/ permanent

        @instrumentDataNoSlash path /instrument-data
        redir @instrumentDataNoSlash /instrument-data/ permanent

        # Serve NexusLIMS preview data (images, metadata)
        handle_path /data/* {
            # CORS headers for file size checking
            header Access-Control-Allow-Origin "*"
            header Access-Control-Allow-Methods "GET, HEAD, OPTIONS"
            header Access-Control-Allow-Headers "*"

            # Handle preflight requests
            @options method OPTIONS
            respond @options 204

            root * {$NX_DATA_PATH}
            file_server {
                browse
            }
        }

        # Serve NexusLIMS instrument data files
        handle_path /instrument-data/* {
            # CORS headers for file size checking
            header Access-Control-Allow-Origin "*"
            header Access-Control-Allow-Methods "GET, HEAD, OPTIONS"
            header Access-Control-Allow-Headers "*"

            # Handle preflight requests
            @options method OPTIONS
            respond @options 204

            root * {$NX_INSTRUMENT_DATA_PATH}
            file_server {
                browse
            }
        }
    }
}
