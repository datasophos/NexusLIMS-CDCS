# Docker Compose override for production deployment
# This file configures production-ready settings with automatic restarts, health checks,
# and production file serving paths
#
# Usage: docker compose -f docker-compose.base.yml -f docker-compose.prod.yml up -d

services:
  caddy:
    restart: unless-stopped
    volumes:
      # Production data paths (configurable via environment variables)
      - ${NX_DATA_HOST_PATH}:${NX_DATA_PATH}:ro
      - ${NX_INSTRUMENT_DATA_HOST_PATH}:${NX_INSTRUMENT_DATA_PATH}:ro
      # Custom certificate mounts (only included when CADDY_CERTS_HOST_PATH is set)
      # When set, the entrypoint script automatically enables TLS in the Caddyfile
      - ${CADDY_CERTS_HOST_PATH:+${CADDY_CERTS_HOST_PATH}/fullchain.pem:/etc/caddy/certs/fullchain.pem:ro}
      - ${CADDY_CERTS_HOST_PATH:+${CADDY_CERTS_HOST_PATH}/privkey.pem:/etc/caddy/certs/privkey.pem:ro}

  postgres:
    restart: unless-stopped

  redis:
    restart: unless-stopped

  cdcs:
    restart: unless-stopped
    volumes:
      # Mount backup directory to host for easy access
      - ${NX_CDCS_BACKUPS_HOST_PATH}:/srv/nexuslims/backups
    environment:
      # Backup path environment variable (only needed in production)
      - NX_CDCS_BACKUPS_HOST_PATH=${NX_CDCS_BACKUPS_HOST_PATH}
      - NX_ADMIN_API_TOKEN=${NX_ADMIN_API_TOKEN}

    # Production: No source code mount, only essential volumes
    # (base config already includes config/xslt/nexuslims_overrides/scripts mounts)

    # Production initialization and server startup
    entrypoint: ["/docker-entrypoint.prod.sh"]


    # Health check for production monitoring
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
